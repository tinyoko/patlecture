# Requirements Document

## Introduction

講演音声ファイルのトランスクリプトを活用したDifyチャットフローと連携する音声再生プレイヤーシステムの開発。ユーザーがチャットで質問すると、講演内容に基づく回答と該当箇所の再生時間が提供され、その時間に基づいて音声プレイヤーで頭出し再生ができる統合システムを構築する。

## Requirements

### Requirement 1

**User Story:** ユーザーとして、講演内容について質問し、該当する音声箇所を即座に聞けるようにしたい

#### Acceptance Criteria

1. WHEN ユーザーがチャットで質問を入力 THEN システムは講演内容に基づく回答と時間範囲（例：[10:05-10:54]）を表示する
2. WHEN チャット応答に時間範囲が含まれる THEN 音声プレイヤーは自動的にその時間範囲を再生範囲として設定する
3. WHEN 時間範囲が指定される THEN 音声プレイヤーは指定された開始時間から終了時間までの範囲で再生する
4. WHEN 時間範囲での再生が終了 THEN 音声プレイヤーは自動的に開始時間に戻ってループ再生する

### Requirement 2

**User Story:** ユーザーとして、音声の波形を視覚的に確認しながら再生位置を調整したい

#### Acceptance Criteria

1. WHEN 音声ファイルが読み込まれる THEN WaveSurfer.jsを使用した波形表示が表示される
2. WHEN ユーザーが波形上をクリック THEN 再生位置がクリック位置に移動する
3. WHEN 音声が再生中 THEN 現在の再生位置が波形上で視覚的に表示される
4. WHEN チャットから時間指定がある THEN 波形上の該当位置がハイライト表示される
5. WHEN ユーザーが波形上で範囲をドラッグ THEN 新しい再生範囲が設定される
6. WHEN 再生範囲が設定される THEN 範囲の境界をドラッグして開始・終了時間を調整できる

### Requirement 3

**User Story:** ユーザーとして、チャットと音声プレイヤーを同一ページで操作したい

#### Acceptance Criteria

1. WHEN ページが読み込まれる THEN Difyチャットフローが埋め込みiframeで表示される
2. WHEN ページが読み込まれる THEN 音声プレイヤーが同一ページに表示される
3. WHEN チャット応答が生成される THEN 時間範囲情報が音声プレイヤーに自動的に連携される
4. WHEN ユーザーがページを操作 THEN チャットと音声プレイヤー間でスムーズな連携が動作する

### Requirement 4

**User Story:** 開発者として、DjangoフレームワークでWebアプリケーションを構築したい

#### Acceptance Criteria

1. WHEN システムが起動される THEN Djangoアプリケーションが正常に動作する
2. WHEN 音声ファイルがアップロードされる THEN システムは適切に音声ファイルを処理・配信する
3. WHEN Dify APIが呼び出される THEN システムは提供されたAPI情報を使用して正常に通信する
4. WHEN ユーザーがページにアクセス THEN レスポンシブなUIが表示される

### Requirement 5

**User Story:** ユーザーとして、チャット応答から音声プレイヤーへの連携が自動的に行われることを期待する

#### Acceptance Criteria

1. WHEN チャット応答に時間範囲パターン [MM:SS-MM:SS] が含まれる THEN システムは自動的にその時間を抽出する
2. WHEN 時間範囲が抽出される THEN 音声プレイヤーは自動的に開始時間にシークする
3. WHEN 複数の時間範囲が応答に含まれる THEN システムは最初の時間範囲を使用する
4. IF 時間範囲が音声ファイルの長さを超える THEN システムは適切なエラーハンドリングを行う

### Requirement 6

**User Story:** ユーザーとして、音声プレイヤーの基本的な操作（再生、停止、音量調整）ができるようにしたい

#### Acceptance Criteria

1. WHEN ユーザーが再生ボタンをクリック THEN 音声が現在位置から再生される
2. WHEN ユーザーが停止ボタンをクリック THEN 音声再生が停止される
3. WHEN ユーザーが音量スライダーを調整 THEN 音声の音量が変更される
4. WHEN 音声が終了 THEN プレイヤーは停止状態に戻る

### Requirement 7

**User Story:** ユーザーとして、指定された時間範囲をループ再生で繰り返し聞きたい

#### Acceptance Criteria

1. WHEN 時間範囲が設定される THEN 音声プレイヤーはその範囲内でのみ再生する
2. WHEN 範囲再生が終了時間に達する THEN 自動的に開始時間に戻って再生を継続する
3. WHEN ユーザーがループ再生を停止 THEN 通常の再生モードに戻る
4. WHEN 新しい時間範囲が設定される THEN 前の範囲設定は上書きされる
5. WHEN ユーザーが範囲外をクリック THEN 範囲設定が解除され通常再生モードになる

### Requirement 8

**User Story:** ユーザーとして、チャットで設定された再生範囲を自由に調整したい

#### Acceptance Criteria

1. WHEN チャットから時間範囲が設定される THEN 波形上に調整可能な範囲マーカーが表示される
2. WHEN ユーザーが範囲の開始マーカーをドラッグ THEN 再生開始時間が調整される
3. WHEN ユーザーが範囲の終了マーカーをドラッグ THEN 再生終了時間が調整される
4. WHEN ユーザーが範囲全体をドラッグ THEN 範囲の長さを保ったまま位置が移動する
5. WHEN 範囲が調整される THEN リアルタイムで新しい時間範囲が表示される