{% extends "player/base.html" %}
{% load static %}

{% block title %}{{ lecture_title }} - Audio Chat Player{% endblock %}

{% block content %}
<div class="header">
    <h1>{{ lecture_title }}</h1>
    <p>è¬›æ¼”éŸ³å£°ã¨ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã®çµ±åˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</p>
</div>

<div class="main-content">
    <!-- Chat Section -->
    <div class="chat-section">
        <div class="chat-header">
            <h2>ğŸ’¬ ãƒãƒ£ãƒƒãƒˆ</h2>
        </div>
        <div class="chat-content">
            <!-- Dify chatbot iframe will be embedded here -->
            <iframe 
                id="chat-iframe"
                class="chat-iframe"
                src="about:blank"
                title="Dify Chatbot"
                allow="microphone; camera">
            </iframe>
            <div id="chat-placeholder" style="padding: 20px; text-align: center; color: #6c757d;">
                <p>ğŸ¤– ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
                <p style="font-size: 0.9rem; margin-top: 10px;">
                    è¬›æ¼”å†…å®¹ã«ã¤ã„ã¦è³ªå•ã—ã¦ãã ã•ã„ã€‚<br>
                    å›ç­”ã«å«ã¾ã‚Œã‚‹æ™‚é–“ç¯„å›² [MM:SS-MM:SS] ã§éŸ³å£°ãŒè‡ªå‹•å†ç”Ÿã•ã‚Œã¾ã™ã€‚
                </p>
            </div>
        </div>
    </div>

    <!-- Audio Player Section -->
    <div class="player-section">
        <div class="player-header">
            <h2>ğŸµ éŸ³å£°ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</h2>
        </div>
        <div class="player-content">
            <!-- Status messages -->
            <div id="status-container"></div>
            
            <!-- Audio waveform -->
            <div id="waveform" class="waveform-container">
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #6c757d;">
                    <p>ğŸµ éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
                </div>
            </div>
            
            <!-- Player controls -->
            <div class="controls">
                <button id="play-btn" class="btn btn-primary" disabled>
                    â–¶ï¸ å†ç”Ÿ
                </button>
                <button id="pause-btn" class="btn btn-secondary" disabled>
                    â¸ï¸ åœæ­¢
                </button>
                <div class="volume-control">
                    <label for="volume-slider">ğŸ”Š</label>
                    <input 
                        type="range" 
                        id="volume-slider" 
                        class="volume-slider"
                        min="0" 
                        max="100" 
                        value="50"
                        disabled>
                    <span id="volume-display">50%</span>
                </div>
            </div>
            
            <!-- Time display -->
            <div class="time-display">
                <div>ç¾åœ¨æ™‚åˆ»: <span id="current-time">00:00</span></div>
                <div>ç·æ™‚é–“: <span id="total-time">00:00</span></div>
                <div id="region-time" style="display: none;">
                    é¸æŠç¯„å›²: <span id="region-start">00:00</span> - <span id="region-end">00:00</span>
                </div>
            </div>
            
            <!-- Audio file info -->
            {% if not audio_exists %}
            <div class="status-message status-error">
                âš ï¸ éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: {{ audio_file_path }}
            </div>
            {% else %}
            <div class="status-message status-success">
                âœ… éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«æº–å‚™å®Œäº†: {{ audio_file_path }}
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Load the modular audio player JavaScript -->
<script src="{% load static %}{% static 'js/audio-player.js' %}"></script>

<script>
// Global audio player controller instance
let audioPlayerController = null;

// Initialize the application when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    initializeApplication();
});

// Initialize the entire application
function initializeApplication() {
    // Check if audio file exists
    {% if not audio_exists %}
    showErrorMessage('éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ç®¡ç†è€…ã«é€£çµ¡ã—ã¦ãã ã•ã„ã€‚');
    return;
    {% endif %}
    
    // Initialize audio player controller
    audioPlayerController = new AudioPlayerController('audio-player', '{{ audio_url }}');
    
    if (audioPlayerController.initialize()) {
        console.log('Audio player initialized successfully');
    } else {
        showErrorMessage('éŸ³å£°ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
    }
    
    // Initialize chat listener placeholder
    initializeChatListener();
}

// Initialize chat message listener (placeholder for iframe communication)
function initializeChatListener() {
    // This will be implemented in task 7 (iframe communication)
    console.log('Chat listener initialized (placeholder)');
    
    // For now, show placeholder message
    setTimeout(() => {
        const chatPlaceholder = document.getElementById('chat-placeholder');
        if (chatPlaceholder) {
            chatPlaceholder.innerHTML = `
                <p>ğŸ¤– ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆçµ±åˆã¯æ¬¡ã®ã‚¿ã‚¹ã‚¯ã§å®Ÿè£…ã•ã‚Œã¾ã™</p>
                <p style="font-size: 0.9rem; margin-top: 10px;">
                    ç¾åœ¨ã¯éŸ³å£°ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒ†ã‚¹ãƒˆãŒå¯èƒ½ã§ã™ã€‚<br>
                    æ³¢å½¢ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦å†ç”Ÿä½ç½®ã‚’å¤‰æ›´ã§ãã¾ã™ã€‚
                </p>
            `;
        }
    }, 2000);
}

// Utility function for showing error messages
function showErrorMessage(message) {
    const statusContainer = document.getElementById('status-container');
    if (statusContainer) {
        statusContainer.innerHTML = `<div class="status-message status-error">${message}</div>`;
    }
}

// Public API for chat integration (will be used in later tasks)
window.AudioPlayer = {
    setTimeRange: function(startTime, endTime) {
        if (audioPlayerController) {
            return audioPlayerController.setTimeRange(startTime, endTime);
        }
        console.warn('Audio player controller not initialized');
        return false;
    },
    
    play: function() {
        if (audioPlayerController && audioPlayerController.player) {
            audioPlayerController.player.play();
        }
    },
    
    pause: function() {
        if (audioPlayerController && audioPlayerController.player) {
            audioPlayerController.player.pause();
        }
    },
    
    getCurrentTime: function() {
        if (audioPlayerController && audioPlayerController.player) {
            return audioPlayerController.player.getCurrentTime();
        }
        return 0;
    },
    
    getDuration: function() {
        if (audioPlayerController && audioPlayerController.player) {
            return audioPlayerController.player.getDuration();
        }
        return 0;
    },
    
    isReady: function() {
        if (audioPlayerController && audioPlayerController.player) {
            return audioPlayerController.player.isReady();
        }
        return false;
    }
};
</script>
{% endblock %}